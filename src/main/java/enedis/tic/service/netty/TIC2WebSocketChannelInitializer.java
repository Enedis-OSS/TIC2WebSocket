// Copyright (C) 2025 Enedis Smarties team <dt-dsi-nexus-lab-smarties@enedis.fr>
// 
// SPDX-FileContributor: Jehan BOUSCH
// SPDX-FileContributor: Mathieu SABARTHES
//
// SPDX-License-Identifier: Apache-2.0

package enedis.tic.service.netty;

import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelPipeline;
import io.netty.channel.socket.SocketChannel;
import io.netty.handler.codec.http.HttpObjectAggregator;
import io.netty.handler.codec.http.HttpServerCodec;
import io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;
import io.netty.handler.codec.http.websocketx.extensions.compression.WebSocketServerCompressionHandler;
import io.netty.handler.stream.ChunkedWriteHandler;

import enedis.tic.service.client.TIC2WebSocketClientPool;
import enedis.tic.service.requesthandler.TIC2WebSocketRequestHandler;

/**
 * Channel initializer for TIC2WebSocket server
 */
public class TIC2WebSocketChannelInitializer extends ChannelInitializer<SocketChannel>
{
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// CONSTANTS
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private static final String WEBSOCKET_PATH = "/";

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// TYPES
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// STATIC METHODS
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// ATTRIBUTES
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private final TIC2WebSocketClientPool clientPool;
    private final TIC2WebSocketRequestHandler requestHandler;

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// CONSTRUCTORS
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /**
     * Constructor
     * 
     * @param clientPool     the client pool
     * @param requestHandler the request handler
     */
    public TIC2WebSocketChannelInitializer(TIC2WebSocketClientPool clientPool, TIC2WebSocketRequestHandler requestHandler)
    {
        this.clientPool = clientPool;
        this.requestHandler = requestHandler;
    }

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// INTERFACE
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// PUBLIC METHODS
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    @Override
    protected void initChannel(SocketChannel ch) throws Exception
    {
        ChannelPipeline pipeline = ch.pipeline();

        // HTTP codec
        pipeline.addLast(new HttpServerCodec());

        // HTTP object aggregator
        pipeline.addLast(new HttpObjectAggregator(65536));

        // Chunked write handler for large messages
        pipeline.addLast(new ChunkedWriteHandler());

        // WebSocket compression
        pipeline.addLast(new WebSocketServerCompressionHandler());

        // WebSocket protocol handler
        pipeline.addLast(new WebSocketServerProtocolHandler(WEBSOCKET_PATH, null, true));

        // Custom TIC2WebSocket handler
        pipeline.addLast(new TIC2WebSocketHandler(clientPool, requestHandler));
    }

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// PROTECTED METHODS
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///
    /// PRIVATE METHODS
    ///
    /// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
