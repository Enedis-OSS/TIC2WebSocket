// Copyright (C) 2025 Enedis Smarties team <dt-dsi-nexus-lab-smarties@enedis.fr>
// 
// SPDX-FileContributor: Jehan BOUSCH
// SPDX-FileContributor: Mathieu SABARTHES
//
// SPDX-License-Identifier: Apache-2.0

package enedis.lab.protocol.tic.codec;

import java.util.List;

import enedis.lab.codec.Codec;
import enedis.lab.codec.CodecException;
import enedis.lab.protocol.tic.frame.TICFrame;
import enedis.lab.protocol.tic.frame.TICFrameDataSet;
import enedis.lab.protocol.tic.frame.historic.TICFrameHistoric;
import enedis.lab.protocol.tic.frame.historic.TICFrameHistoricDataSet;
import enedis.lab.types.BytesArray;

/**
 * Codec TIC Frame Historic
 *
 */
public class CodecTICFrameHistoric implements Codec<TICFrameHistoric, byte[]>
{
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// CONSTANTS
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/** Separator */
	public static final byte SEPARATOR = 0x20; // SP

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// TYPES
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// STATIC METHODS
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// ATTRIBUTES
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// CONSTRUCTORS
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// INTERFACE
	/// Codec
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@Override
	public TICFrameHistoric decode(byte[] bytesBuffer) throws CodecException
	{
		String errorMessage = "";
		BytesArray rawDataSet = null;
		TICFrameHistoric ticFrame = null;
		CodecTICFrameHistoricDataSet codecTICFrameHistoricDataSet = new CodecTICFrameHistoricDataSet();

		BytesArray bytesArray = new BytesArray(bytesBuffer);

		if ((true == bytesArray.startsWith(TICFrame.BEGINNING_PATTERN)) && (true == bytesArray.endsWith(TICFrame.END_PATTERN)) && (bytesArray.contains(TICFrame.EOT) == false))
		{
			bytesArray.remove(0);
			bytesArray.remove(bytesArray.size() - 1);

			ticFrame = new TICFrameHistoric();

			List<BytesArray> datasetList = bytesArray.slice(TICFrameDataSet.BEGINNING_PATTERN, TICFrameDataSet.END_PATTERN, BytesArray.CONTIGUOUS);

			if (datasetList.isEmpty() == false)
			{
				for (int i = 0; i < datasetList.size(); i++)
				{
					TICFrameHistoricDataSet dataSet = null;
					rawDataSet = datasetList.get(i);
					byte[] rawDataSetByte = rawDataSet.getBytes();

					try
					{
						dataSet = codecTICFrameHistoricDataSet.decode(rawDataSetByte);
						ticFrame.addDataSet(dataSet);
					}
					catch (CodecException exception)
					{
						errorMessage += exception.getMessage() + " : " + new String(rawDataSet.getBytes()) + "\n";
					}
				}
			}
		}

		if (errorMessage.isEmpty())
		{
			return ticFrame;
		}
		else
		{
			throw new CodecException(errorMessage, ticFrame);
		}

	}

	@Override
	public byte[] encode(TICFrameHistoric ticFrameHistoric) throws CodecException
	{
		String errorMessage = "";
		CodecTICFrameHistoricDataSet codec = new CodecTICFrameHistoricDataSet();
		BytesArray dataSet = new BytesArray();

		List<TICFrameDataSet> ticFrameHistoricList = ticFrameHistoric.getDataSetList();

		if (ticFrameHistoric != null && !ticFrameHistoricList.isEmpty())
		{
			List<TICFrameDataSet> groups = ticFrameHistoric.getDataSetList();
			dataSet.add(TICFrame.BEGINNING_PATTERN);
			for (int i = 0; i < groups.size(); i++)
			{
				try
				{
					byte[] buff = codec.encode((TICFrameHistoricDataSet) groups.get(i));
					dataSet.addAll(buff);
				}
				catch (CodecException e)
				{
					errorMessage += e.getMessage() + " : " + new String(ticFrameHistoric.getBytes()) + "\n";
				}
			}
			dataSet.add(TICFrame.END_PATTERN);
		}

		else
		{
			return null;
		}

		if (errorMessage.isEmpty())
		{
			return dataSet.getBytes();
		}
		else
		{
			throw new CodecException(errorMessage, dataSet.getBytes());
		}
	}

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// PROTECTED METHODS
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	///
	/// PRIVATE METHODS
	///
	/// ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}